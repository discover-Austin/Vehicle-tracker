<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Vehicle Tracking System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/api.js"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8 flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2">Analytics Dashboard</h1>
                    <p class="text-gray-400">Comprehensive insights and statistics</p>
                </div>
                <a href="/index.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
                    Back to Dashboard
                </a>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Searches</p>
                            <p id="stat-total-searches" class="text-3xl font-bold mt-2">-</p>
                        </div>
                        <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Detections</p>
                            <p id="stat-total-detections" class="text-3xl font-bold mt-2">-</p>
                        </div>
                        <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Active Cameras</p>
                            <p id="stat-active-cameras" class="text-3xl font-bold mt-2">-</p>
                        </div>
                        <svg class="w-12 h-12 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Avg Confidence</p>
                            <p id="stat-avg-confidence" class="text-3xl font-bold mt-2">-</p>
                        </div>
                        <svg class="w-12 h-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Detection Trends Chart -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Detection Trends</h2>
                        <select id="trend-period" class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm">
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d" selected>Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="1y">Last Year</option>
                        </select>
                    </div>
                    <canvas id="trends-chart" height="300"></canvas>
                </div>

                <!-- Top Cameras Chart -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4">Top Performing Cameras</h2>
                    <canvas id="cameras-chart" height="300"></canvas>
                </div>
            </div>

            <!-- Success Rate -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
                <h2 class="text-xl font-semibold mb-4">Search Success Rate</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <p class="text-gray-400 mb-2">Successful Searches</p>
                        <p id="success-count" class="text-4xl font-bold text-green-400">-</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400 mb-2">Failed Searches</p>
                        <p id="failed-count" class="text-4xl font-bold text-red-400">-</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400 mb-2">Success Rate</p>
                        <p id="success-rate" class="text-4xl font-bold text-blue-400">-</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h2 class="text-xl font-semibold mb-4">Recent Activity</h2>
                <div id="activity-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-400">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const api = new VehicleTrackerAPI();

        // Check authentication
        if (!api.token) {
            window.location.href = '/login.html';
        }

        let trendsChart, camerasChart;

        async function loadDashboardStats() {
            try {
                const { stats } = await api.getDashboardStats();
                document.getElementById('stat-total-searches').textContent = stats.totalSearches || 0;
                document.getElementById('stat-total-detections').textContent = stats.totalDetections || 0;
                document.getElementById('stat-active-cameras').textContent = stats.activeCameras || 0;
                document.getElementById('stat-avg-confidence').textContent =
                    stats.avgConfidence ? (stats.avgConfidence * 100).toFixed(1) + '%' : 'N/A';
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }

        async function loadTrends(period = '7d') {
            try {
                const { trends } = await api.getDetectionTrends(period);

                const labels = trends.map(t => t.period);
                const data = trends.map(t => t.count);

                if (trendsChart) {
                    trendsChart.destroy();
                }

                const ctx = document.getElementById('trends-chart').getContext('2d');
                trendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Detections',
                            data,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load trends:', error);
            }
        }

        async function loadTopCameras() {
            try {
                const { cameras } = await api.getTopCameras(5);

                const labels = cameras.map(c => c.name);
                const data = cameras.map(c => c.detection_count);

                if (camerasChart) {
                    camerasChart.destroy();
                }

                const ctx = document.getElementById('cameras-chart').getContext('2d');
                camerasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Detections',
                            data,
                            backgroundColor: 'rgba(168, 85, 247, 0.7)',
                            borderColor: 'rgb(168, 85, 247)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load top cameras:', error);
            }
        }

        async function loadSuccessRate() {
            try {
                const data = await api.getSearchSuccessRate();
                document.getElementById('success-count').textContent = data.successfulSearches;
                document.getElementById('failed-count').textContent = data.failedSearches;
                document.getElementById('success-rate').textContent = data.successRate + '%';
            } catch (error) {
                console.error('Failed to load success rate:', error);
            }
        }

        async function loadActivity() {
            try {
                const { activities } = await api.getActivity(20);
                const activityList = document.getElementById('activity-list');

                if (activities.length === 0) {
                    activityList.innerHTML = '<p class="text-gray-400">No recent activity</p>';
                    return;
                }

                activityList.innerHTML = activities.map(activity => `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-start gap-3">
                        <svg class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="flex-1">
                            <p class="font-medium">Detection at ${activity.camera_name}</p>
                            <p class="text-sm text-gray-400">License: ${activity.license_plate} â€¢ Confidence: ${(activity.confidence * 100).toFixed(1)}%</p>
                            <p class="text-xs text-gray-500 mt-1">${new Date(activity.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load activity:', error);
            }
        }

        // Event listeners
        document.getElementById('trend-period').addEventListener('change', (e) => {
            loadTrends(e.target.value);
        });

        // Initial load
        loadDashboardStats();
        loadTrends();
        loadTopCameras();
        loadSuccessRate();
        loadActivity();

        // Refresh data every 30 seconds
        setInterval(() => {
            loadDashboardStats();
            loadActivity();
        }, 30000);
    </script>
</body>
</html>
